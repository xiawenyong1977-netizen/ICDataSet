# 微信截图制作方法总结

## 1. 技术方案选择

### 原始方案（已放弃）
- **GAN模型**：尝试了 `torchgan`、`pytorch-gan-zoo`、`stylegan2-pytorch` 等
- **问题**：生成的图像质量差，多为"彩色噪声图像"，不符合实际需求

### 最终方案（推荐）
- **Stable Diffusion模型**：使用 `runwayml/stable-diffusion-v1-5`
- **优势**：预训练模型，生成质量高，支持提示词控制

## 2. 核心提示词优化

### 正面提示词结构
```
professional ID photo, single person, {age} {gender} person, 
straight front view, looking directly at camera, high quality face, 
studio lighting, solid white background, head centered, crop at neck, 
shoulders only, no chest, no torso, ears visible, neutral expression, 
passport photo, straight posture, level shoulders
```

### 负面提示词结构
```
blurry, low quality, distorted, multiple people, side view, hat, 
sunglasses, mask, jewelry, makeup, artistic, cartoon, anime, text, 
watermark, chest, torso, stomach, full body, complex background, 
patterned background, outdoor background, furniture, objects, tilted, 
slanted, crooked, asymmetric, uneven shoulders, angled view
```

## 3. 关键控制要素

### 姿势控制
- `straight front view` - 完全正面视角
- `looking directly at camera` - 直视摄像头
- `straight posture` - 端正姿势
- `level shoulders` - 水平肩部

### 裁剪控制
- `crop at neck` - 在颈部裁剪
- `shoulders only` - 只露出肩部
- `no chest, no torso` - 避免露出胸部和躯干

### 背景控制
- `solid white background` - 纯白色背景
- `plain background, no patterns` - 无图案、无纹理

## 4. 图像后处理流程

### 步骤1：人脸区域裁剪
- 确保包含完整的头部和耳朵
- 调整到目标尺寸 (308x376)

### 步骤2：光线增强
- 使用CLAHE（对比度受限的自适应直方图均衡化）
- 消除阴影，提升整体亮度
- 目标亮度：≥120

### 步骤3：纯色背景创建
- 创建纯白色背景
- 将头像居中放置

### 步骤4：耳朵清晰度优化
- 应用边缘增强滤波器
- 提升细节清晰度

### 步骤5：最终质量检查
- 验证亮度和对比度
- 必要时进行最终调整

## 5. 技术参数设置

### Stable Diffusion参数
- **推理步数**：25步（更多步数获得更好质量）
- **引导比例**：8.0（更高引导获得更符合提示的图像）
- **图像尺寸**：512x512（生成后裁剪到308x376）

### 内存优化
- 启用注意力切片：`enable_attention_slicing()`
- 启用VAE切片：`enable_vae_slicing()`
- 使用半精度：`torch.float16`

## 6. 使用流程

### 单个生成
```bash
python face_gen_advanced.py
# 选择选项1：生成单个身份证头像
```

### 批量生成
```bash
python face_gen_advanced.py
# 选择选项2：批量生成身份证头像
# 输入所需数量
```

## 7. 质量保证措施

### 图像质量检查
- 亮度检查：平均亮度 ≥120
- 对比度检查：标准差 ≥30
- 自动重试机制

### 错误处理
- 生成失败时创建默认头像
- 详细的日志记录
- 异常捕获和处理

## 8. 输出规格

### 最终图像要求
- **尺寸**：308x376像素（身份证标准）
- **格式**：PNG（支持透明背景）
- **质量**：95%压缩质量
- **背景**：纯白色
- **内容**：头部+肩部，无胸部露出

## 9. 优化建议

### 提示词优化
- 保持在77个token以内（避免CLIP截断）
- 重点词汇放在前面
- 负面提示词要具体明确

### 模型选择
- 优先使用预训练的Stable Diffusion模型
- 考虑使用专门的人像生成模型
- 定期更新模型版本

## 10. 总结

这套方法可以生成符合身份证要求的专业头像，具有以下特点：

✅ **光线明亮**：使用CLAHE技术消除阴影，确保光线均匀  
✅ **姿势端正**：通过提示词控制确保正面视角和水平肩部  
✅ **背景纯色**：生成纯白色背景，符合证件照要求  
✅ **裁剪精确**：只露出肩部，避免胸部暴露  
✅ **质量稳定**：Stable Diffusion模型保证生成质量  
✅ **批量处理**：支持单个和批量生成模式  

适合各种证件照需求，包括身份证、护照、工作证等官方文件使用。

---

*本文档基于实际开发经验总结，涵盖了从技术选型到最终实现的完整流程。*
